<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <title>Import Wanchain Key File</title>
</head>
<body>
    <div class="alert alert-success fade" role="alert">
        <strong id='success-text'></strong>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="alert alert-danger fade" role="alert">
        <strong id='err-text'></strong>
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="importKey">
        <div class="container">
            <div class="row justify-content-center align-items-center">
                <h1>Import Wanchain Key File</h1>
                <div class="col-12">
                    <form id="KeyFileForm" novalidate>
                        <div class="form-group">
                            <label class="label text-dark" for="oldpwd">Enter old password for key file</label>
                            <input id="oldpwd" name="oldpwd" class="form-control" type="password" required />
                            <div id="kfFeedback" class="invalid-feedback">Please provide a valid password for key file.</div>
                        </div>
                        <div class="form-group"> 
                            <label class="label text-dark" for="newpwd">Enter the password for wan wallet</label>
                            <input id="newpwd" name="newpwd" class="form-control" type="password" required />
                            <div class="invalid-feedback">Please provide a valid password for wan wallet.</div>
                        </div>
                        <p style="margin-top: 40px; margin-bottom: 7px;">Choose a key file: </p>
                        <div class="custom-file" style="height: 70px;">
                            <input type="file" class="custom-file-input" id="keyfile" name="keyfile" required />
                            <label class="custom-file-label" for="keyfile" style="overflow: hidden;"></label>
                            <div class="invalid-feedback" style="margin-top: 10px;">Please choose a valide key file.</div>
                        </div>
                        
                        <div class="form-group"> 
                            <button id="submit" type="submit" class="btn btn-dark btn-lg btn-block">Submit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>  
    </div> 
</body>
<script type="application/javascript">
    (function() {
        const ERR_NOT_FOUND = 'cannot proceed, wallet not created or been locked'
        const ERR_WRONG_PWD_KEYFILE = 'invalid password for key file'
        const ERR_WRONG_PWD_WALLET = 'invalid password for wan wallet'
        const ERR_INVALID_KEYFILE = 'invalid key file format'
        const TEXT_SUCCESS = 'key file import complete, close this window and go to main page for more detail'

        window.addEventListener('load', function() {
            const fileSelector = document.querySelector('#keyfile')
            const subBtn = document.querySelector('#submit')
            const alertError = document.querySelector('.alert-danger')
            const alertSuccess = document.querySelector('.alert-success')
            const form = document.getElementById('KeyFileForm')
            const errText = document.getElementById('err-text')
            const successText = document.getElementById('success-text')
            const closeBtns = document.querySelectorAll('.close')

            closeBtns.forEach(btn => {
                btn.addEventListener('click', function(){
                    const parent = btn.parentElement
                    if (parent.classList.contains('show')) parent.classList.remove('show')
                })
            })

            fileSelector.addEventListener('change', function() {
                const value = fileSelector.files[0]
                document.querySelector('.custom-file-label').innerHTML = value.name
            })
            
            subBtn.addEventListener('click', e => {
                event.preventDefault();
                event.stopPropagation();

                errText.innerHTML = ''
                successText.innerHTML = ''

                if (alertError.classList.contains('show')) alertError.classList.remove('show')
                if (alertSuccess.classList.contains('show')) alertSuccess.classList.remove('show')

                form.classList.add('was-validated');

                const formData = new FormData(form)
                const keyFilePwd = formData.get('oldpwd')
                const hdWalletPwd = formData.get('newpwd')
                const fileDesc = formData.get('keyfile')

                if (keyFilePwd && hdWalletPwd && fileDesc.path) {
                    wand.request('address_fromKeyFile', { keyFilePwd, hdWalletPwd, keyFilePath: fileDesc.path }, function(err, val) {
                        if (err) {
                            const desc = err.desc || err.message

                            if (desc.includes('not found')) {
                                errText.innerHTML = ERR_NOT_FOUND
                            } 

                            if (desc.includes('authentication code mismatch')) {
                                errText.innerHTML = ERR_WRONG_PWD_KEYFILE
                            }

                            if (desc.includes('Invalid password')) {
                                errText.innerHTML = ERR_WRONG_PWD_WALLET
                            }

                            if (desc.includes("Cannot read property 'cipherparams'")) {
                                errText.innerHTML = ERR_INVALID_KEYFILE
                            }
            
                            alertError.classList.add('show')

                            return
                        }

                        if (val) {
                            successText.innerHTML = TEXT_SUCCESS
                            alertSuccess.classList.add('show')    
                        }            
                    })
                }
        
            })
        }, false)
    })()
</script>


</html>